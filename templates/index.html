<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Công cụ Phân tích Văn bản</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Công cụ Phân tích Văn bản</h1>
      <a class="text-sm text-slate-500 hover:text-slate-700" href="https://spacy.io" target="_blank">spaCy</a>
    </header>

    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 space-y-4">
      <label for="text" class="block text-sm font-medium text-slate-700">Nhập đoạn văn</label>
      <textarea id="text" class="w-full min-h-40 p-3 border border-slate-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500"
        placeholder="Nhập hoặc dán đoạn văn...">Apple will open a new office in Ho Chi Minh City next year. Tim Cook met with Prime Minister Pham Minh Chinh in April 2023.</textarea>

      <div class="flex items-center gap-3">
        <button id="btnAnalyze" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50">
          Phân tích
        </button>
        <span id="status" class="text-sm text-slate-500"></span>
      </div>

      <!-- Banner engine/lang -->
      <div id="banner" class="hidden rounded-xl border p-3 text-sm"></div>

      <details class="bg-slate-50 rounded-xl border border-slate-200 p-4">
        <summary class="cursor-pointer text-sm font-medium text-slate-700">Chú thích</summary>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-3 text-sm" id="legendBox"></div>
      </details>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <h2 class="text-lg font-semibold mb-3">Tokens & POS</h2>
        <div class="overflow-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-slate-700">
              <tr>
                <th class="px-3 py-2 text-left">Token</th>
                <th class="px-3 py-2 text-left">Lemma</th>
                <th class="px-3 py-2 text-left">POS</th>
                <th class="px-3 py-2 text-left">Tag</th>
              </tr>
            </thead>
            <tbody id="tblTokens" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5">
        <h2 class="text-lg font-semibold mb-3">Thực thể đặt tên (NER)</h2>
        <p class="text-sm text-slate-500 mb-2">Di chuột lên nhãn để xem mô tả.</p>
        <div id="ents" class="flex flex-wrap gap-2"></div>
        <h3 class="text-sm font-medium text-slate-600 mt-4">Câu</h3>
        <ul id="sents" class="list-disc pl-6 text-sm text-slate-700"></ul>
      </div>
    </section>
  </div>

  <script>
    const btn = document.getElementById('btnAnalyze');
    const statusEl = document.getElementById('status');
    const tblTokens = document.getElementById('tblTokens');
    const ents = document.getElementById('ents');
    const sents = document.getElementById('sents');
    const legendBox = document.getElementById('legendBox');
    const banner = document.getElementById('banner');

    const legendPromise = fetch('/api/legend').then(r => r.json());

    btn.addEventListener('click', async () => {
      btn.disabled = true;
      statusEl.textContent = 'Đang phân tích...';
      ents.innerHTML = ''; sents.innerHTML = ''; tblTokens.innerHTML = '';
      banner.className = 'hidden';
      banner.textContent = '';

      try {
        const text = document.getElementById('text').value;

        const analyzePromise = fetch('/api/analyze', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ text })
        }).then(r => r.json());

        const [legend, data] = await Promise.all([legendPromise, analyzePromise]);

        renderLegend(legend);
        renderBanner(data);

        (data.tokens || []).forEach(r => {
          const tr = document.createElement('tr');
          const posTitle = legend.pos[r.pos] || 'POS';
          const tagTitle = legend.tag[r.tag] || 'Tag';
          tr.innerHTML = `
            <td class="px-3 py-2 font-medium">${escapeHTML(r.t)}</td>
            <td class="px-3 py-2 text-slate-600">${escapeHTML(r.lemma)}</td>
            <td class="px-3 py-2">
              <span class="px-2 py-0.5 rounded-lg bg-indigo-50 text-indigo-700" title="${escapeHTML(posTitle)}">
                ${escapeHTML(r.pos)}
              </span>
            </td>
            <td class="px-3 py-2 text-slate-600" title="${escapeHTML(tagTitle)}">${escapeHTML(r.tag)}</td>`;
          tblTokens.appendChild(tr);
        });

        (data.entities || []).forEach(e => {
          const span = document.createElement('span');
          span.className = "px-2 py-1 rounded-lg bg-emerald-50 text-emerald-700 border border-emerald-200";
          span.title = legend.ent[e.label] || 'Thực thể';
          span.textContent = `${e.text} — ${e.label}`;
          ents.appendChild(span);
        });

        (data.sentences || []).forEach(t => {
          const li = document.createElement('li');
          li.textContent = t;
          sents.appendChild(li);
        });

        statusEl.textContent = 'Hoàn tất.';
      } catch (e) {
        statusEl.textContent = 'Lỗi.';
        console.error(e);
      } finally {
        btn.disabled = false;
      }
    });

    function renderLegend(legend){
      if (legendBox.dataset.rendered === '1') return;
      const col = (title, obj) => {
        const ul = Object.entries(obj).slice(0, 12)
          .map(([k,v]) => `<li><span class="font-mono">${k}</span> — ${escapeHTML(v)}</li>`).join('');
        return `<div><div class="font-semibold mb-2">${title}</div><ul class="space-y-1 text-slate-700">${ul}</ul></div>`;
      };
      legendBox.innerHTML =
        col('POS (UPOS)', legend.pos) +
        col('Tag (Penn Treebank)', legend.tag) +
        col('Nhãn NER', legend.ent);
      legendBox.dataset.rendered = '1';
    }

    function renderBanner(data){
      const engine = data.engine_used || 'spacy_en';
      const lang = data.lang || 'unknown';
      const conf = data.confidence != null ? ` (độ tin cậy ~ ${Math.round((data.confidence||0)*100)}%)` : '';
      const note = data.notice ? ` — ${escapeHTML(data.notice)}` : '';

      banner.className = `rounded-xl border p-3 text-sm ${
        engine === 'spacy_stanza_vi' ? 'border-emerald-300 bg-emerald-50 text-emerald-800' :
        'border-indigo-300 bg-indigo-50 text-indigo-800'
      }`;
      banner.textContent = `Engine: ${engine}, ngôn ngữ: ${lang}${conf}${note}`;
    }

    function escapeHTML(s){
      const div = document.createElement('div');
      div.textContent = s ?? '';
      return div.innerHTML;
    }
  </script>
</body>
</html>
